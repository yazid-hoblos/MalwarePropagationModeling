## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
library(igraph)
library(networkD3)
library(dplyr)
library(deSolve)
library(statnet)
library(EpiModel)
library(flextable)
library(GGally)
library(ggraph)
library(igraph)
library(Matrix)
library(network)
library(quanteda)
library(sna)
library(tidygraph)
library(tidyverse)
library(tm)
library(tibble)
library(GA)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
charger <- list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Charger",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows  

jisut = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Jisut",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                             
  bind_rows

koler = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Koler",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows

lockerpin = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Lockerpin",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows

pletor = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Pletor",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows

porndroid = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/PornDroid",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows

ransomBO = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/RansomBO",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows

simplocker = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/Simplocker",  
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                             
  bind_rows

SVpeng = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/SVpeng", 
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                             
  bind_rows

wannalocker = list.files(path = "C:/Users/yazid/Downloads/ransomwares/Ransomware/WannaLocker", 
                       pattern = "*.csv", full.names = TRUE) %>% 
  lapply(read.csv) %>%                              
  bind_rows 

df = rbind (charger, jisut, koler, lockerpin, pletor, porndroid, ransomBO, simplocker, SVpeng, wannalocker)
nrow(df)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
write.csv(df,'whole_dataset.csv')
length(unique(df$Destination.Port))
unique(df)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
timeSteps = unique(df$Timestamp)
length(timeSteps)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
n = c()
j=1
for (i in 1:nrow(df)){
  n[j] = paste(df$Source.IP[i],df$Source.Port[i])
  n[j+1] = paste(df$Destination.IP[i],df$Destination.Port[i])
  j=j+2
}
nodes = unique(n)
length(nodes)


## ----eval=F------------------------------------------------------------------------------------------------------------------------------------------------------------
## write.csv(as.data.frame(nodes), "Nodes.csv", row.names=FALSE)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
e = c()
for (i in 1:nrow(df)){
  e[i] = paste(df$Source.IP[i], df$Source.Port[i], df$Destination.IP[i], df$Destination.Port[i])
}

ed = unique(e)
length(ed)

s = t =c()
j=1
for(i in ed){
  str = strsplit(i, " ")[[1]]
  s[j]= paste(str[1],str[2])
  t[j]= paste (str[3],str[4])
  j=j+1
}
edges = as.data.frame(cbind(s,t))
colnames(edges)[1] = 'source'
colnames(edges)[2] = 'target'
edges$weight = 0
View(df)
View(edges)
for(j in 1:nrow(new_data)){
  p=j
  if(j>=214487){
    p=214487
  }
  for(i in 1:p){
    if(new_data$source[j] == edges$source[i] && new_data$target[j]==edges$target[i]){
      edges$weight[i] = edges$weight[i]+as.numeric(new_data$forward_packets[j])
    }
  }
}

write.csv(edges, "Edges.csv", row.names=FALSE)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
df = df %>% arrange(substr(df$Timestamp,1,2))

values = c()
for (i in 1:nrow(df)){
  if (!(substr(df$Timestamp[i],1,2) %in% values)){
  values=cbind(values,substr(df$Timestamp[i],1,2))
}
}


p=1
for (i in 2:nrow(df)){
  if (substr(df$Timestamp[i],1,2) != substr(df$Timestamp[i-1],1,2)){
    df[p:(i-1),] =df[p:(i-1),] %>% arrange(substr(df$Timestamp[p:(i-1)],12,13))
    p=i
  }
}

p=1
for (i in 235868:nrow(df)){
  if (substr(df$Timestamp[i],12,13) != substr(df$Timestamp[i-1],12,13)){
    df[p:(i-1),] =df[p:(i-1),] %>% arrange(substr(df$Timestamp[p:(i-1)],15,16))
    p=i
  }
}

p=1
for (i in 2:nrow(df)){
  if (substr(df$Timestamp[i],15,16) != substr(df$Timestamp[i-1],15,16)){
    df[p:(i-1),] =df[p:(i-1),] %>% arrange(substr(df$Timestamp[p:(i-1)],18,19))
    p=i
  }
}


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
source = target = c()
for(i in 1:nrow(df)){
  source[i] = paste(df$Source.IP[i], df$Source.Port[i])
  target[i] = paste(df$Destination.IP[i], df$Destination.Port[i])
}
new_data = as.data.frame(cbind(source, target, df$Timestamp, df$Total.Fwd.Packets, df$Flow.Duration, df$Protocol,df$Label))
colnames(new_data)[3] = 'timeStamp'
colnames(new_data)[4] = 'forward_packets'
colnames(new_data)[5] = 'flow_duration'
colnames(new_data)[6] = 'protocol'
colnames(new_data)[7] = 'type'
View(new_data)
new_data$flow_duration = as.numeric(new_data$flow_duration)/1000
write.csv(df, "mutated_df.csv", row.names=FALSE)


## ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
View(new_data)
d = as.network(new_data,multiple=TRUE,duplicate=FALSE,weight)
d
saveRDS(d, file = "network.rds")
fwd = as.matrix(as.numeric(new_data$forward_packets))
set.network.attribute(d,'fwd',fwd)
set.network.attribute(d,'label',as.matrix(new_data$type))
list.network.attributes(d)
d
summary(d~edges+edgecov('fwd'))
ergm = ergm(d~edges+edgecov('fwd'))
summary(ergm)

dim(fwd)
d
View(fwd)
fwdd = as.vector(fwd)
e <- round(runif(10,min = 1,max = 5))
is.vector(fwdd)
gc()
memory.limit()

set.edge.value(d,"weight",fwdd)

plot(d,mode='fruchtermanreingold',interactive=TRUE,vertex.col=c('b','r','y'))

