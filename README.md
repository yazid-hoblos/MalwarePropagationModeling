# MalwarePropagationModeling

## Overview

This project attempts to use the SIS (Susceptible-Infectious-Susceptible) epidemiological model to simulate the propagation of Malware in a network of devices. The relevant parameters, namely the transmission rate (β) and the recovery rate (γ), are tuned using GA (Genetic Algorithm).

## Dataset

The [CIC-AndMal2017](https://www.unb.ca/cic/datasets/andmal2017.html) dataset of the _Canadian Institute for Cybersecurity_ was used for this project [1]. It consists of the APK files for the android ransomware verified applications that were used to collect the network flow information, the PCAP files displaying the packets transmissions within the network over time (recorded using tcpdump), and CSV files extracted from the PCAP network flow files with 84 recorded features
(collected using [CICFlowMeter](https://www.unb.ca/cic/research/applications.html#CICFlowMeter)).

Ten ransomware families are covered, and for each around ten network flows are recorded at different time points across a few days. The packets transmission recording approach was conducted as depicted in the diagram below. 

![image](https://github.com/yazid-hoblos/MalwarePropagationModeling/assets/125372209/1ee3bee3-18c7-47d0-93ab-1c2ba63dece4)

The PCAP files recorded were inspected using [Wireshark](https://www.wireshark.org/), which offers a set of tools for
analyzing network flow information. Using these files offers more flexibility than the extracted
CSV files by allowing the inspection of the full details of each connection (packet transmission),
as well as selecting and analyzing the features of interest, building flow graphs representatives of
the network over time, or scaling the recorded features as needed.

## Selected Features and Network Representation

The IP addresses, the ports, the time stamps, and the forward packets were the main relevant features for our analysis. They were used to create a network representation for the transmisions between the devices. A total of 4582 IP addresses were found. Combined with their corresponsing ports, these IP addresses result in a total of 104292 nodes. Edges represent the packets transmissions between nodes. A total of 214487 edges were found. A total of 72036 unique
timestamps were found as well.

The network could be either represented dynamically or as a static multigraph, as the same two nodes could have multiple interactions as different points in time.

Typically, authors segregate their data into specified time windows. For instance, Fang et al. (2022) segregated their data
into 20 seconds time windows, while Martens et al. (2016) worked with 1 hour time
windows [2][3]. In some cases, inspecting the patterns of the network evolution over time offers
essential insights that help increasing the model accuracy. For example, Chernikova et al. (2022) 
found that consecutive infection attempts originating from the same host are delayed by a
non-homogeneous time interval, which prompted them to suggest a modified SIIDR with an additional node state
termed ID (infected-dormant state) [4]. A similar window was defined for the CICandMAL2017 dataset 
to obtain accurate patterns for the modeling of the edges formation and dissolution over time as well as
the latency of the different node states.

Finally, the forward packets were regarded as edge weights, adding
a parameter that affects the network structure, unlike the infection and
recovery rates which affect the states of the nodes over time. Several techniques for using the edges weights for edge-breaking were previously advanced [5]. Of these approaches, the inverse strategy, whereby the edge-breaking probability is taken to be inversely proportional to the
edge weight, was most adequate for our purposes, as the more packets transmitted between 2 nodes, the lower the probability of a sudden disruption of their interaction. 

The final data was reduced to the form below.

![image](https://github.com/yazid-hoblos/MalwarePropagationModeling/assets/125372209/d229de15-f375-4ce9-b0b4-32f797847515)

## Network Topology

Gephi was used for network visualization. In the graph below, the red nodes [r] have an out-degree of 0, the blue [b] nodes have an out-degree of 1,
the yellow [y] nodes have an out-degree of 2, and the pink [p] nodes have an out-degree of 3. The distribution of in-degrees is as presented to the right.

![image](https://github.com/yazid-hoblos/MalwarePropagationModeling/assets/125372209/9214f119-2911-48e1-a2e3-da3bab1094fc)

## SIS-GA Approach

The SIS model was used to model the Malware transmissions within the network. Its parameters were tuned using GA. The optimized fitness function was defined in terms of the accuracy of predictions achieved by the SIS model, i.e. its assignment of _S_ and _I_ states to the nodes over time. 

## Advanced Network-based Enhancements 

### Network Simulation

Finding the optimal formulae to accurately represent the edges formation and
dossociation patterns is challenging. Yet, with enough features available and upon inspecting the
network thoroughly especially in its dynamic form, patterns should progressively emerge. The
[ERGM](https://cran.r-project.org/web/packages/ergm/index.html) package in R offers a function that could capture a set of the network statistics using the
available data (number of edges, the number of triangles, degrees of the
nodes…) [7]. There is a specific term offered for each of these features. Once the relevant network statistics are identified, 
the [EpiModel](https://www.epimodel.org/) package could be used to create the edges formation formula, through which along with
the edges duration data, the dissociation formula could be also computed [8]. EpiModel also offers a
function to assess the simulated networks accuracy in representing the actual data. Once the
generated network achieves a satisfactory accuracy level, the epidemics model of choice could be
applied next.

### Dynamic Network Representation

Multiple dynamic representations could be applied.

First, the dynamic network could be formed using the sequence of the networks at each timestep
which could be done through the [networkDynamic](https://cran.r-project.org/web/packages/networkDynamic/index.html) package. 
The standard case in this scenario would be the recording of the set of connections in a closed population (with a fixed number of
nodes) at equally spaced timesteps. If the network is to be considered open allowing for new
nodes entry, the dynamic network could be built using a set of recordings which do not have the
same number of nodes, so that the number of nodes is allowed to increase over time.

Second, the dynamic network could be built by considering the full network with all the nodes
and edges at all timesteps as one cross-section while using the flow durations to model the
evolution of edges over time. The standard case in this scenario would be the collection of the set
of nodes and their edges at one point in time (one cross-section), with information on how long
the edges seem to last and the different potential factors affecting their lasting duration used
to model the evolution of this recorded cross-section.

Third, the network could be evolved relying on the information offered through egocentric data
(i.e. data collected based on surveying individuals and their interactions). This type of data is the
least informative and simplest to get.

These approaches were tested on the CICandMAL2017 dataset. Data splits for each timestep
alone were created, along with their corresponding networks and the set of infected and
susceptible individuals at each timestep. Next, dynamic networks were created by using the set
of 72036 created networks. Alternatively, a dynamic network simulation was created by
considering the network as one cross-section and feeding the model the mean duration of the
edges.

## References

1. A. H. Lashkari, A. F. A. Kadir, L. Taheri and A. A. Ghorbani, "Toward Developing a
Systematic Approach to Generate Benchmark Android Malware Datasets and
Classification," 2018 International Carnahan Conference on Security Technology
(ICCST), Montreal, QC, Canada, 2018, pp. 1-7, doi: 10.1109/CCST.2018.8585560.
2. Fang, Z., Zhao, P., Xu, M., Xu, S., Hu, T., & Fang, X. (2022). Statistical modeling of
computer malware propagation dynamics in cyberspace. Journal of Applied Statistics,
49(4), 858-883. https://doi.org/10.1080/02664763.2020.1845621
3. M. Märtens, H. Asghari, M. van Eeten and P. Van Mieghem, "A time-dependent
SIS-model for long-term computer worm evolution," 2016 IEEE Conference on
Communications and Network Security (CNS), Philadelphia, PA, USA, 2016, pp.
207-215, doi: 10.1109/CNS.2016.7860487.
4. Chernikova, A., Gozzi, N., Boboila, S., Perra, N., Eliassi-Rad, T., & Oprea, A. (2022).
Modeling self-propagating malware with epidemiological models. (). Ithaca: Cornell
University Library, arXiv.org. https://doi.org/10.48550/arXiv.2208.03276
5. Xiu-Xiu Zhan, Chuang Liu, Zi-Ke Zhang, Gui-Quan Sun. Roles of edge weights on
epidemic spreading dynamics. Physica A: Statistical Mechanics and its Applications,
Volume 456, 2016, Pages 228-234, ISSN 0378-4371.
https://doi.org/10.1016/j.physa.2016.03.088
6. F. Noorbehbahani, F. Rasouli and M. Saberi, "Analysis of Machine Learning Techniques
for Ransomware Detection," 2019 16th International ISC (Iranian Society of Cryptology)
Conference on Information Security and Cryptology (ISCISC), Mashhad, Iran, 2019, pp.
128-133, doi: 10.1109/ISCISC48546.2019.8985139.
7. Hunter, D. R., Handcock, M. S., Butts, C. T., Goodreau, S. M., & Morris, M. (2008). ergm: A Package to Fit, Simulate and Diagnose Exponential-Family Models for Networks. Journal of statistical software, 24(3), nihpa54860. https://doi.org/10.18637/jss.v024.i03
8. Jenness, S. M., Goodreau, S. M., & Morris, M. (2018). EpiModel: An R Package for Mathematical Modeling of Infectious Disease over Networks. Journal of statistical software, 84, 8. https://doi.org/10.18637/jss.v084.i08


